{% extends 'main/base.html' %}

{% block title %}Destination{% endblock %}

{% block content %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Packing Planner</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --card-bg: rgba(255,255,255,0.88); /* semi-transparent white so wallpaper shows */
      --card-accent: rgba(255,182,193,0.08);
      --accent:#ff99ff;
      --accent-2:#cc99ff;
      --muted:#6b7280;
      --shadow: 0 14px 40px rgba(2,6,23,0.12);
      --max-card-w: 980px;
      --nav-offset: 64px; /* expected navbar height in base.html */
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif}
    html,body{
      height:100%;
      background: #fefefe url('{{ url_for("static", filename="wallpaper-doodle.webp") }}') no-repeat center center fixed;
      background-size:cover;
      overflow:hidden; /* page non-scrollable as requested */
      color:#0f172a;
    }

    /* center card with margins so it doesn't touch header/footer */
    .viewport {
      height: calc(100vh - var(--nav-offset));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .card-wrap{
      width:100%;
      max-width:var(--max-card-w);
      min-width:320px;
      max-height: calc(100vh - (var(--nav-offset) + 80px)); /* keep margin top/bottom */
      background: var(--card-bg);
      border-radius:12px;
      padding:18px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:hidden;
      margin: 10px auto; /* small vertical breathing room */
    }

    /* hero */
    .hero{
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px;
      border-radius:10px;
      background: linear-gradient(90deg, rgba(255,153,255,0.04), rgba(204,153,255,0.02));
    }
    .place-img{width:72px;height:52px;border-radius:8px;object-fit:cover}
    .hero h1{font-size:18px;margin:0}
    .hero p{margin-top:4px;color:var(--muted);font-size:13px}
    .weather{text-align:right;font-size:13px;color:var(--muted)}

    /* main grid - left form, right packing */
    .main-grid{
      display:flex;
      gap:14px;
      align-items:flex-start;
      flex:1;
      min-height:320px;
    }
    .form-card{
      flex:1;
      min-width:300px;
      padding:10px;
      border-radius:10px;
      background:transparent;
      overflow:auto;
    }
    .packing-card{
      width:420px;
      min-width:300px;
      padding:10px;
      border-radius:10px;
      background:transparent;
      overflow:auto;
    }

    /* inputs/buttons */
    .input-row{display:flex;gap:8px;margin-bottom:8px}
    .input-row input, .input-row select{
      flex:1;padding:9px;border-radius:8px;border:1px solid rgba(2,6,23,0.08);background:#fff;font-size:14px
    }
    .small{flex:0 0 120px;width:120px}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#05202b;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(2,6,23,0.08)}
    .btn.peach{background:var(--accent-2);color:#05202b}

    /* progress */
    .progress{height:8px;background:rgba(2,6,23,0.04);border-radius:999px;overflow:hidden;margin:10px 0}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}

    /* options chips */
    .options{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .option{
      padding:8px 12px;border-radius:999px;border:1px solid rgba(2,6,23,0.06);cursor:pointer;background:#fff;user-select:none;font-size:14px
    }
    .option.selected{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border-color:transparent;box-shadow:0 10px 24px rgba(0,0,0,0.06)}
    .option.disabled{opacity:0.45;pointer-events:none}

    /* items & suitcase */
    .items{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:10px;max-height:260px;overflow:auto;padding-right:6px}
    .item{padding:8px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);background:#fff;cursor:pointer;text-align:center;font-size:13px}
    .item.added{opacity:0.45;pointer-events:none}
    .suitcase-drop{margin-top:12px;padding:12px;border-radius:12px;border:2px dashed rgba(2,6,23,0.06);background:var(--card-accent);min-height:240px;position:relative}
    .suitcase-body{position:absolute;left:50%;top:22px;transform:translateX(-50%);width:360px;height:140px;border-radius:12px;background:linear-gradient(180deg,#eef9ff,#ffffff);border:1px solid rgba(0,0,0,0.04)}
    .suitcase-inner{position:absolute;left:50%;top:70px;transform:translateX(-50%);width:340px;padding:10px;display:flex;gap:8px}
    .suitcase-slot{flex:1;min-height:72px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);background:#fff;padding:6px;overflow:auto}
    .hint{color:var(--muted);font-size:13px;margin-top:8px;text-align:center}

    /* final packing list style */
    .packing-list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .packing-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.95);border:1px solid rgba(2,6,23,0.04)}

    /* responsiveness */
    @media(max-width:980px){
      .main-grid{flex-direction:column-reverse;align-items:stretch}
      .packing-card{width:100%}
      .card-wrap{padding:12px}
      .hero{flex-wrap:wrap}
      .viewport{padding:12px}
    }

    /* small scrollbar style */
    .items::-webkit-scrollbar{width:6px}
    .items::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.08);border-radius:6px}
  </style>
</head>
<body>
  <div class="viewport" role="main" aria-live="polite">
    <div class="card-wrap" role="region" aria-label="Packing planner card">
      <!-- HERO -->
      <div class="hero" role="banner">
        <img class="place-img" src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1200&auto=format&fit=crop" alt="place">
        <div style="flex:1">
          <h1 id="placeName">Choose a destination</h1>
          <p id="placeTag">Smart packing generated by duration, gender & activities.</p>
        </div>
        <div class="weather" aria-hidden="false">
          <div id="temp">--¬∞C</div>
          <div id="cond">--</div>
        </div>
      </div>

      <!-- MAIN GRID -->
      <div class="main-grid">
        <!-- LEFT: form -->
        <section class="form-card" id="formCard" aria-label="Trip configuration">
          <!-- From/To and route -->
          <div class="input-row">
            <input id="fromInput" placeholder="From (city)" aria-label="From">
            <input id="toInput" placeholder="To (city/country)" aria-label="To">
            <button class="btn" id="routeBtn" title="Suggest routes">How to go</button>
          </div>
          <div id="routeSuggestion" style="margin-bottom:8px;color:var(--muted);font-size:13px"></div>

          <!-- Name/destination + weather setter -->
          <div class="input-row">
            <input id="username" placeholder="Your name (required)" aria-label="Your name">
            <input id="destinationInput" placeholder="Destination (required)" aria-label="Destination">
            <button class="btn" id="setDestBtn">Set</button>
          </div>

          <div class="progress" aria-hidden="true"><i id="progressBar"></i></div>

          <div id="formSteps">
            <!-- STEP 1 -->
            <div class="form-step active" data-step="1" aria-live="polite">
              <h4 style="font-size:15px;margin-bottom:6px">How many days?</h4>
              <input type="range" id="duration" min="1" max="30" value="3" oninput="durationVal.innerText=this.value" aria-label="Duration">
              <div style="margin:6px 0"><strong><span id="durationVal">3</span> days</strong></div>

              <h4 style="font-size:15px;margin-top:8px">Gender</h4>
              <div class="options" id="genderOptions" aria-label="Gender">
                <div class="option" data-value="unspecified">Unspecified</div>
                <div class="option" data-value="male">Male</div>
                <div class="option" data-value="female">Female</div>
                <div class="option" data-value="other">Other</div>
              </div>

              <h4 style="font-size:15px;margin-top:10px">Travel company (one)</h4>
              <div class="options" id="companyOptions" aria-label="Travel company">
                <div class="option" data-value="solo">Solo</div>
                <div class="option" data-value="partner">Partner</div>
                <div class="option" data-value="family">Family</div>
              </div>

              <h4 style="font-size:15px;margin-top:10px">Travel mode (one)</h4>
              <div class="options" id="modeOptions" aria-label="Travel mode">
                <div class="option" data-value="flight">Flight ‚úàÔ∏è</div>
                <div class="option" data-value="train">Train üöÜ</div>
                <div class="option" data-value="road">Road üöó</div>
                <div class="option" data-value="bus">Bus üöå</div>
                <div class="option" data-value="ship">Ship üö¢</div>
              </div>
            </div>

            <!-- STEP 2 -->
            <div class="form-step" data-step="2">
              <h4 style="font-size:15px">Activities (up to 4)</h4>
              <div class="options" id="activityOptions" aria-label="Activities">
                <div class="option" data-value="beach">Beach üèñ</div>
                <div class="option" data-value="hiking">Hiking ü•æ</div>
                <div class="option" data-value="camping">Camping ‚õ∫</div>
                <div class="option" data-value="sightseeing">Sightseeing üè∞</div>
                <div class="option" data-value="adventure">Adventure üé¢</div>
                <div class="option" data-value="city">City life üèôÔ∏è</div>
                <div class="option" data-value="ski">Skiing ‚õ∑Ô∏è</div>
              </div>

              <h4 style="font-size:15px;margin-top:10px">Medical needs (one)</h4>
              <div class="options" id="medicalOptions">
                <div class="option" data-value="none">None</div>
                <div class="option" data-value="allergy">Allergy</div>
                <div class="option" data-value="back">Back pain</div>
                <div class="option" data-value="diabetes">Diabetes</div>
              </div>

              <h4 style="font-size:15px;margin-top:10px">Packing style (one)</h4>
              <div class="options" id="styleOptions">
                <div class="option" data-value="minimal">Minimalist</div>
                <div class="option" data-value="comfort">Comfort</div>
                <div class="option" data-value="luxury">Luxury</div>
              </div>
            </div>

            <!-- STEP 3 -->
            <div class="form-step" data-step="3">
              <h4 style="font-size:15px">All set! ‚úÖ</h4>
              <p style="color:var(--muted);margin-top:6px">Click <strong>Generate Packing List</strong> to create your packing list and virtual suitcase.</p>
            </div>
          </div>

          <!-- controls -->
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
            <button class="btn ghost" id="prevBtn">Back</button>
            <div style="display:flex;gap:8px">
              <button class="btn" id="nextBtn">Next</button>
              <button class="btn peach" id="generateBtn" style="display:none">Generate Packing List</button>
            </div>
          </div>
        </section>

        <!-- RIGHT: packing -->
        <aside class="packing-card" id="packingCard" aria-label="Packing area">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <h4 id="greeting">Hey Traveller!</h4>
              <div class="mini" id="tripSummary" style="color:var(--muted)">Trip summary appears here</div>
            </div>
            <div style="text-align:right;color:var(--muted);font-size:13px">
              <div id="routeSmall"></div>
            </div>
          </div>

          <div class="day-tabs" id="dayTabs" style="margin-top:10px;display:none"></div>

          <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
            <strong>Packing list</strong>
            <div style="font-size:13px;color:var(--muted)">Click to pack</div>
          </div>

          <div id="packingArea">
            <div class="items" id="itemsContainer" aria-live="polite"></div>

            <div style="display:flex;justify-content:center;gap:8px;margin-top:8px">
              <button id="prevItem" class="btn ghost">Prev</button>
              <div id="pageInfo" style="align-self:center;color:var(--muted)">Page 1/1</div>
              <button id="nextItem" class="btn ghost">Next</button>
            </div>
          </div>

          <div id="finalList" style="display:none" aria-live="polite">
            <div class="packing-list" id="generatedList"></div>
            <div style="margin-top:10px">
              <strong>Suitcase</strong>
              <div class="suitcase-drop" id="suitcaseDrop">
                <div class="suitcase-body"></div>
                <div class="suitcase-inner">
                  <div class="suitcase-slot" id="slotLeft" aria-live="polite"></div>
                  <div class="suitcase-slot" id="slotRight" aria-live="polite"></div>
                </div>
              </div>
              <div class="hint">Click an item to move it into the suitcase. Each item only once.</div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- SCRIPT: All logic -->
  <script>
    /* ======= CONFIG ======= */
    const API_KEY = '05f85e36fd42f0d1f359f276caab551f';

    /* ======= STATE ======= */
    const state = {
      username: '',
      destination: '',
      from: '',
      to: '',
      duration: 3,
      gender: 'unspecified',
      company: '',
      mode: '',
      activities: [],
      medical: '',
      style: '',
      allItems: [],
      generatedItems: [],
      addedToSuitcase: new Set(),
      currentPage: 1,
      itemsPerPage: 8
    };

    /* ======= ELEMENTS ======= */
    const steps = Array.from(document.querySelectorAll('.form-step'));
    const progressBar = document.getElementById('progressBar');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const generateBtn = document.getElementById('generateBtn');
    const durationEl = document.getElementById('duration');
    const durationVal = document.getElementById('durationVal');
    const itemsContainer = document.getElementById('itemsContainer');
    const pageInfo = document.getElementById('pageInfo');
    const prevItem = document.getElementById('prevItem');
    const nextItem = document.getElementById('nextItem');
    const slotLeft = document.getElementById('slotLeft');
    const slotRight = document.getElementById('slotRight');
    const setDestBtn = document.getElementById('setDestBtn');
    const fromInput = document.getElementById('fromInput');
    const toInput = document.getElementById('toInput');
    const routeBtn = document.getElementById('routeBtn');
    const routeSuggestion = document.getElementById('routeSuggestion');
    const routeSmall = document.getElementById('routeSmall');
    const placeName = document.getElementById('placeName');
    const tempEl = document.getElementById('temp');
    const condEl = document.getElementById('cond');
    const greeting = document.getElementById('greeting');
    const tripSummary = document.getElementById('tripSummary');
    const formCard = document.getElementById('formCard');

    /* ======= NAVIGATION (Next/Back) ======= */
    let currentStep = 0;
    function showStep(i){
      steps.forEach((s,idx)=> s.classList.toggle('active', idx===i));
      currentStep = i;
      const pct = Math.round(((i+1)/steps.length)*100);
      progressBar.style.width = pct + '%';
      prevBtn.style.display = i===0 ? 'none' : 'inline-block';
      nextBtn.style.display = i===steps.length-1 ? 'none' : 'inline-block';
      generateBtn.style.display = i===steps.length-1 ? 'inline-block' : 'none';
      // ensure generate visible when at last step
      if(i===steps.length-1) generateBtn.style.display = 'inline-block';
    }
    showStep(0);
    prevBtn.addEventListener('click', ()=> showStep(Math.max(0, currentStep-1)));
    nextBtn.addEventListener('click', ()=> showStep(Math.min(steps.length-1, currentStep+1)));

    /* ======= Option helpers ======= */
    function makeSingleSelect(id, onChange){
      const container = document.getElementById(id);
      if(!container) return;
      container.addEventListener('click', e=>{
        const opt = e.target.closest('.option');
        if(!opt) return;
        container.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
        opt.classList.add('selected');
        if(onChange) onChange(opt.dataset.value);
      });
    }
    function makeLimitedMultiSelect(id, limit=4, stateArray){
      const container = document.getElementById(id);
      if(!container) return;
      container.addEventListener('click', e=>{
        const opt = e.target.closest('.option');
        if(!opt) return;
        const val = opt.dataset.value;
        if(opt.classList.contains('selected')){
          opt.classList.remove('selected');
          const idx = stateArray.indexOf(val);
          if(idx>-1) stateArray.splice(idx,1);
        } else {
          if(stateArray.length >= limit){
            opt.style.transform = 'scale(0.98)';
            setTimeout(()=> opt.style.transform = '', 120);
            return;
          }
          opt.classList.add('selected');
          stateArray.push(val);
        }
      });
    }

    makeSingleSelect('genderOptions', v=> state.gender = v);
    makeSingleSelect('companyOptions', v=> state.company = v);
    makeSingleSelect('modeOptions', v=> state.mode = v);
    makeSingleSelect('medicalOptions', v=> state.medical = v);
    makeSingleSelect('styleOptions', v=> state.style = v);
    makeLimitedMultiSelect('activityOptions', 4, state.activities);

    /* duration binding */
    durationEl.addEventListener('input', ()=>{
      state.duration = parseInt(durationEl.value,10);
      durationVal.innerText = durationEl.value;
    });

    /* ======= Set dest & weather ======= */
    setDestBtn.addEventListener('click', ()=>{
      const user = document.getElementById('username').value.trim();
      const dest = document.getElementById('destinationInput').value.trim();
      if(!user || !dest){ alert('Please enter your name and destination'); return; }
      state.username = user;
      state.destination = dest;
      placeName.innerText = dest;
      greeting.innerText = `Hey ${state.username || 'Traveller'}!`;
      tripSummary.innerText = `${state.duration} day(s) ¬∑ ${state.company || '‚Äî'} ¬∑ ${state.mode || '‚Äî'}`;
      fetchWeather(dest);
    });

    async function fetchWeather(place){
      try{
        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(place)}&units=metric&appid=${API_KEY}`);
        const data = await res.json();
        if(data && data.main){
          tempEl.innerText = Math.round(data.main.temp) + '¬∞C';
          condEl.innerText = data.weather[0].main;
        } else {
          tempEl.innerText = 'N/A';
          condEl.innerText = '--';
        }
      } catch(err){
        console.log('weather err', err);
        tempEl.innerText = 'N/A';
        condEl.innerText = '--';
      }
    }

    /* ======= Route suggestions (show ALL plausible modes) ======= */
    routeBtn.addEventListener('click', ()=>{
      const from = fromInput.value.trim();
      const to = toInput.value.trim();
      state.from = from;
      state.to = to;
      if(!from || !to){
        routeSuggestion.innerText = 'Enter both From and To to get route suggestions.';
        routeSmall.innerText = '';
        return;
      }
      const modes = determineAllModes(from, to);
      routeSuggestion.innerHTML = `Possible: <strong>${modes.join(' ¬∑ ')}</strong>`;
      routeSmall.innerText = `${from} ‚Üí ${to} ¬∑ ${modes[0]}`;
    });

    function determineAllModes(a,b){
      const list = new Set();
      // Always include Flight as a possible option
      list.add('Flight');
      const domestic = isLikelyDomestic(a,b);
      if(domestic){
        list.add('Train');
        list.add('Bus');
        list.add('Road (Car)');
      } else {
        // for international or long trips include Train+Flight combos and Ferry if coastal
        list.add('Train + Flight (if partial)');
        list.add('Road (Car)');
        if(mayHaveSeaRoute(a,b)) list.add('Ship/Ferry');
      }
      return Array.from(list);
    }

    function isLikelyDomestic(a,b){
      const foreign = ['japan','usa','united states','canada','uk','germany','france','australia','china','singapore','brazil','russia','italy'];
      const lowA = a.toLowerCase(), lowB = b.toLowerCase();
      for(const f of foreign) if(lowA.includes(f) || lowB.includes(f)) return false;
      // If either contains a comma (city, country) with recognized country, treat as international
      if(lowA.includes(',') || lowB.includes(',')) return false;
      // short token heuristic
      if(a.length < 16 && b.length < 16) return true;
      return false;
    }
    function mayHaveSeaRoute(a,b){
      const hints = ['sea','island','port','coast','harbor','bay','isle'];
      const combined = (a + ' ' + b).toLowerCase();
      for(const h of hints) if(combined.includes(h)) return true;
      return false;
    }

    /* ======= Items generation logic (quantities based on duration/gender/activities) ======= */
    function generatePackingList(){
      const days = state.duration;
      const gender = state.gender;
      const activities = state.activities.slice();
      const style = state.style;

      // base logic
      const shirts = Math.max(1, Math.ceil(days * 1.0)); // 1 per day
      const underwear = Math.max(1, Math.ceil(days * 1.0));
      const socks = Math.max(1, Math.ceil(days * 1.0));
      const jeans = Math.max(1, Math.ceil(days / 4));
      const shorts = Math.max(0, Math.ceil(days / 3));
      const pajamas = Math.max(1, Math.ceil(days / 7));
      const jacket = (days > 5 || activities.includes('hiking') || activities.includes('ski')) ? 1 : 0;
      const shoesPairs = 1 + (activities.includes('hiking') ? 1 : 0);
      const sandals = activities.includes('beach') ? 1 : 0;
      const swimsuit = activities.includes('beach') ? 1 : 0;

      // essentials
      const toiletries = 1;
      const meds = state.medical !== 'none' ? 1 : 0;
      const charger = 1;
      const powerbank = 1;
      const camera = (activities.includes('sightseeing') || activities.includes('adventure')) ? 1 : 0;

      let list = [];
      list.push({name:'T-shirts', qty: shirts});
      if(jeans) list.push({name:'Jeans', qty: jeans});
      if(shorts) list.push({name:'Shorts', qty: shorts});
      list.push({name:'Underwear', qty: underwear});
      list.push({name:'Socks', qty: socks});
      if(pajamas) list.push({name:'Pajamas', qty: pajamas});
      if(jacket) list.push({name:'Jacket', qty: jacket});
      list.push({name:'Shoes (pairs)', qty: shoesPairs});
      if(sandals) list.push({name:'Sandals', qty: sandals});
      if(swimsuit) list.push({name:'Swimsuit', qty: swimsuit});

      list.push({name:'Toiletries kit', qty: toiletries});
      if(meds) list.push({name:'Medical kit / prescriptions', qty:1});
      list.push({name:'Phone charger', qty:charger});
      list.push({name:'Powerbank', qty:powerbank});
      if(camera) list.push({name:'Camera', qty:camera});
      list.push({name:'Water bottle', qty:1});
      list.push({name:'Sunglasses', qty:1});
      list.push({name:'Hat / Cap', qty:1});
      list.push({name:'Notebook & pen', qty:1});

      // gender adjustments (small and non-stereotypical)
      if(gender === 'female'){
        list.push({name:'Extra top/outfit', qty: Math.max(1, Math.ceil(days/5))});
      } else if(gender === 'male'){
        if(days > 7) list.push({name:'Extra shirt', qty: Math.ceil(days/7)});
      }

      // activity extras
      const activityMap = {
        beach: [{name:'Beach towel', qty:1},{name:'Flip-flops', qty:1}],
        hiking: [{name:'Backpack', qty:1},{name:'Trekking shoes', qty:1}],
        camping: [{name:'Sleeping bag', qty:1},{name:'Torch', qty:1}],
        sightseeing: [{name:'Guidebook', qty:1}],
        adventure: [{name:'Light protective gear', qty:1}],
        ski: [{name:'Ski jacket', qty:1},{name:'Thermals', qty:1}],
        city: [{name:'Day bag', qty:1}]
      };
      for(const act of activities){
        const extras = activityMap[act] || [];
        extras.forEach(e=>{
          const found = list.find(x=>x.name===e.name);
          if(found) found.qty = Math.max(found.qty, e.qty);
          else list.push({name:e.name, qty:e.qty});
        });
      }

      // style
      if(style === 'luxury'){
        list.push({name:'Evening outfit', qty: Math.max(1, Math.ceil(days/7))});
        list.push({name:'Evening shoes', qty:1});
      } else if(style === 'minimal'){
        const shirtsItem = list.find(x=>x.name==='T-shirts');
        if(shirtsItem) shirtsItem.qty = Math.max(1, Math.round(shirtsItem.qty * 0.85));
      }

      // normalize and merge duplicates
      const uniq = {};
      list.forEach(i=>{
        const key = i.name;
        uniq[key] = (uniq[key] || 0) + Math.round(i.qty);
      });
      const final = Object.keys(uniq).map(k=>({name:k, qty:uniq[k]})).sort((a,b)=>a.name.localeCompare(b.name));
      state.generatedItems = final;
      return final;
    }

    /* ======= Pre-generate sample items (before final) ======= */
    function buildSampleItems(){
      const sample = ['T-shirt','Pants','Jacket','Shoes','Socks','Toothbrush','Sunglasses','Charger','Water Bottle','Hat','Notebook','Camera','Swimsuit','Flip-flops','Backpack'];
      state.allItems = Array.from(new Set(sample));
      state.currentPage = 1;
      renderItemsPage();
    }

    function renderItemsPage(){
      const start = (state.currentPage - 1) * state.itemsPerPage;
      const end = start + state.itemsPerPage;
      const page = state.allItems.slice(start, end);
      itemsContainer.innerHTML = '';
      page.forEach(name=>{
        const div = document.createElement('div');
        div.className = 'item';
        div.innerText = name;
        if(state.addedToSuitcase.has(name)) { div.classList.add('added'); div.title='Already added'; }
        div.addEventListener('click', ()=> {
          if(state.addedToSuitcase.has(name)) return;
          addToSuitcase(name);
          div.classList.add('added');
        });
        itemsContainer.appendChild(div);
      });
      const total = Math.max(1, Math.ceil(state.allItems.length / state.itemsPerPage));
      pageInfo.innerText = `Page ${state.currentPage}/${total}`;
    }

    prevItem.addEventListener('click', ()=>{
      if(state.currentPage > 1){ state.currentPage--; renderItemsPage(); }
    });
    nextItem.addEventListener('click', ()=>{
      const total = Math.ceil(state.allItems.length / state.itemsPerPage);
      if(state.currentPage < total){ state.currentPage++; renderItemsPage(); }
    });

    function addToSuitcase(name){
      if(state.addedToSuitcase.has(name)) return;
      state.addedToSuitcase.add(name);
      const node = document.createElement('div');
      node.className = 'item';
      node.style.margin = '4px 0';
      node.innerText = name;
      if(slotLeft.childElementCount <= slotRight.childElementCount) slotLeft.appendChild(node);
      else slotRight.appendChild(node);
    }

    /* ======= Generate final packing list and update UI ======= */
    generateBtn.addEventListener('click', ()=>{
      if(!state.username || !state.destination){
        alert('Please set your name and destination first.');
        return;
      }
      const final = generatePackingList();
      // hide form card to show final list only
      document.getElementById('formCard').style.display = 'none';
      document.getElementById('packingArea').style.display = 'none';
      document.getElementById('finalList').style.display = 'block';
      // populate generatedList
      const generatedList = document.getElementById('generatedList');
      generatedList.innerHTML = '';
      final.forEach(item=>{
        const row = document.createElement('div');
        row.className = 'packing-row';
        const left = document.createElement('div');
        left.innerText = `${item.name}`;
        const right = document.createElement('div');
        right.innerText = `${item.qty}`;
        row.appendChild(left);
        row.appendChild(right);
        row.style.cursor = 'pointer';
        row.addEventListener('click', ()=>{
          if(state.addedToSuitcase.has(item.name)) return;
          addToSuitcase(item.name);
          row.style.opacity = '0.5';
        });
        generatedList.appendChild(row);
      });
      // hide controls
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      generateBtn.style.display = 'none';
    });

    /* ======= init ======= */
    (function init(){
      durationVal.innerText = durationEl.value;
      buildSampleItems();
    })();

    /* ======= accessibility & key handlers ======= */
    document.getElementById('destinationInput').addEventListener('keypress', e=>{ if(e.key==='Enter') setDestBtn.click(); });
    fromInput.addEventListener('keypress', e=>{ if(e.key==='Enter') routeBtn.click(); });
    toInput.addEventListener('keypress', e=>{ if(e.key==='Enter') routeBtn.click(); });
    document.querySelectorAll('.options').forEach(group=>{
      group.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && e.target.classList.contains('option')) e.target.click();
      });
    });
  </script>
</body>
</html>
{% endblock %}
