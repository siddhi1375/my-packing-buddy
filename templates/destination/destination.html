{% extends 'main/base.html' %}

{% block title %}Destination{% endblock %}

{% block content %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Packing Planner</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fefefe;
      --card:rgba(255,255,255,0.85); /* semi-transparent white ‚Äî shows wallpaper */
      --card-soft-pink:rgba(255,182,193,0.08); /* subtle pink overlay inside suitcase area */
      --accent:#ff99ff;
      --accent-2:#cc99ff;
      --muted:#6b7280;
      --shadow: 0 12px 30px rgba(2,6,23,0.12);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif}
    html,body{
      height:100%;
      background: #fefefe url('{{ url_for("static", filename="wallpaper-doodle.webp") }}') no-repeat center center fixed;
      background-size:cover;
      overflow:hidden; /* no page scroll per request */
      color:#0f172a;
    }

    /* page wrapper (accounting for base.html nav height) */
    .viewport{height:calc(100vh - 64px);display:flex;align-items:center;justify-content:center;padding:18px;}
    .card-wrap{
      width:100%;
      max-width:1160px;
      background:var(--card);
      border-radius:14px;
      padding:18px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:hidden;
    }

    /* hero */
    .hero{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(90deg, rgba(255,153,255,0.06), rgba(204,153,255,0.03));}
    .place-img{width:72px;height:52px;border-radius:8px;object-fit:cover;}
    .hero h1{font-size:18px;margin:0}
    .hero p{margin-top:4px;color:var(--muted);font-size:13px}
    .weather{text-align:right;font-size:13px;color:var(--muted)}

    /* layout */
    .main-grid{display:flex;gap:12px;flex:1;align-items:flex-start;}
    .form-card{flex:1;min-width:320px;background:transparent;padding:8px;border-radius:10px;overflow:hidden}
    .packing-card{width:420px;min-width:300px;background:transparent;padding:8px;border-radius:10px}

    /* inputs */
    .input-row{display:flex;gap:8px;margin-bottom:8px}
    .input-row input, .input-row select{flex:1;padding:9px;border-radius:8px;border:1px solid rgba(2,6,23,0.08);background:#fff}
    .input-row .small{width:120px;flex:0 0 120px}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#05202b;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(2,6,23,0.08)}
    .btn.peach{background:var(--accent-2);color:#05202b}

    /* progress */
    .progress{height:8px;background:rgba(2,6,23,0.04);border-radius:999px;overflow:hidden;margin:10px 0}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}

    /* options */
    .options{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .option{padding:8px 12px;border-radius:999px;border:1px solid rgba(2,6,23,0.06);cursor:pointer;background:#fff;user-select:none}
    .option.selected{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border-color:transparent;box-shadow:0 10px 24px rgba(0,0,0,0.06)}
    .option.disabled{opacity:0.45;pointer-events:none}

    /* items & suitcase */
    .items{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:10px;max-height:260px;overflow:auto;padding-right:6px}
    .item{padding:8px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);background:#fff;cursor:pointer;text-align:center}
    .item.added{opacity:0.45;pointer-events:none}
    .suitcase-drop{margin-top:12px;padding:12px;border-radius:12px;border:2px dashed rgba(2,6,23,0.06);background:var(--card-soft-pink);min-height:240px;position:relative}
    .suitcase-body{position:absolute;left:50%;top:22px;transform:translateX(-50%);width:360px;height:140px;border-radius:12px;background:linear-gradient(180deg,#eef9ff,#ffffff);border:1px solid rgba(0,0,0,0.04)}
    .suitcase-inner{position:absolute;left:50%;top:70px;transform:translateX(-50%);width:340px;padding:10px;display:flex;gap:8px}
    .suitcase-slot{flex:1;min-height:72px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);background:#fff;padding:6px;overflow:auto}
    .hint{color:var(--muted);font-size:13px;margin-top:8px;text-align:center}

    /* final packing list */
    .packing-list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .packing-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.95);border:1px solid rgba(2,6,23,0.04)}

    /* small screens */
    @media(max-width:980px){
      .main-grid{flex-direction:column-reverse;align-items:stretch}
      .packing-card{width:100%}
      .card-wrap{padding:14px}
      .hero{flex-wrap:wrap}
      html,body{overflow:hidden}
    }
    /* scrollbar tiny */
    .items::-webkit-scrollbar{width:6px}
    .items::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.08);border-radius:6px}
  </style>
</head>
<body>
  <div class="viewport" role="main">
    <div class="card-wrap" aria-live="polite">
      <!-- HERO -->
      <div class="hero">
        <img class="place-img" src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1200&auto=format&fit=crop" alt="place">
        <div style="flex:1">
          <h1 id="placeName">Choose a destination</h1>
          <p id="placeTag">Smart packing generated by duration, gender & activities.</p>
        </div>
        <div class="weather" aria-hidden="false">
          <div id="temp">--¬∞C</div>
          <div id="cond">--</div>
        </div>
      </div>

      <!-- MAIN GRID -->
      <div class="main-grid">
        <!-- LEFT: form -->
        <section class="form-card" id="formCard" aria-label="Trip configuration">
          <!-- From/To and route -->
          <div class="input-row">
            <input id="fromInput" placeholder="From (city)" aria-label="From">
            <input id="toInput" placeholder="To (city/country)" aria-label="To">
            <button class="btn" id="routeBtn" title="Suggest routes">How to go</button>
          </div>
          <div id="routeSuggestion" style="margin-bottom:8px;color:var(--muted);font-size:13px"></div>

          <!-- Name/destination + weather setter -->
          <div class="input-row">
            <input id="username" placeholder="Your name (required)" aria-label="Your name">
            <input id="destinationInput" placeholder="Destination (required)" aria-label="Destination">
            <button class="btn" id="setDestBtn">Set</button>
          </div>

          <div class="progress" aria-hidden="true"><i id="progressBar"></i></div>

          <div id="formSteps">
            <!-- STEP 1 -->
            <div class="form-step active" data-step="1" aria-live="polite">
              <h4 style="font-size:15px;margin-bottom:6px">How many days?</h4>
              <input type="range" id="duration" min="1" max="30" value="3" oninput="durationVal.innerText=this.value" aria-label="Duration">
              <div style="margin:6px 0"><strong><span id="durationVal">3</span> days</strong></div>

              <h4 style="font-size:15px;margin-top:8px">Gender</h4>
              <div class="options" id="genderOptions" aria-label="Gender">
                <div class="option" data-value="unspecified">Unspecified</div>
                <div class="option" data-value="male">Male</div>
                <div class="option" data-value="female">Female</div>
                <div class="option" data-value="other">Other</div>
              </div>

              <h4 style="font-size:15px;margin-top:10px">Travel company (choose one)</h4>
              <div class="options" id="companyOptions" aria-label="Travel company">
                <div class="option" data-value="solo">Solo</div>
                <div class="option" data-value="partner">Partner</div>
                <div class="option" data-value="family">Family</div>
              </div>

              <h4 style="font-size:15px;margin-top:10px">Travel mode (choose one)</h4>
              <div class="options" id="modeOptions" aria-label="Travel mode">
                <div class="option" data-value="flight">Flight ‚úàÔ∏è</div>
                <div class="option" data-value="train">Train üöÜ</div>
                <div class="option" data-value="road">Road üöó</div>
                <div class="option" data-value="bus">Bus üöå</div>
                <div class="option" data-value="ship">Ship üö¢</div>
              </div>
            </div>

            <!-- STEP 2 -->
            <div class="form-step" data-step="2">
              <h4 style="font-size:15px">Activities (up to 4)</h4>
              <div class="options" id="activityOptions" aria-label="Activities">
                <div class="option" data-value="beach">Beach üèñ</div>
                <div class="option" data-value="hiking">Hiking ü•æ</div>
                <div class="option" data-value="camping">Camping ‚õ∫</div>
                <div class="option" data-value="sightseeing">Sightseeing üè∞</div>
                <div class="option" data-value="adventure">Adventure üé¢</div>
                <div class="option" data-value="city">City life üèôÔ∏è</div>
                <div class="option" data-value="ski">Skiing ‚õ∑Ô∏è</div>
              </div>

              <h4 style="font-size:15px;margin-top:10px">Medical needs (one)</h4>
              <div class="options" id="medicalOptions">
                <div class="option" data-value="none">None</div>
                <div class="option" data-value="allergy">Allergy</div>
                <div class="option" data-value="back">Back pain</div>
                <div class="option" data-value="diabetes">Diabetes</div>
              </div>

              <h4 style="font-size:15px;margin-top:10px">Packing style (one)</h4>
              <div class="options" id="styleOptions">
                <div class="option" data-value="minimal">Minimalist</div>
                <div class="option" data-value="comfort">Comfort</div>
                <div class="option" data-value="luxury">Luxury</div>
              </div>
            </div>

            <!-- STEP 3 -->
            <div class="form-step" data-step="3">
              <h4 style="font-size:15px">All set! ‚úÖ</h4>
              <p style="color:var(--muted);margin-top:6px">Click <strong>Generate Packing List</strong> to create your packing list and virtual suitcase.</p>
            </div>
          </div>

          <!-- controls -->
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
            <button class="btn ghost" id="prevBtn">Back</button>
            <div style="display:flex;gap:8px">
              <button class="btn" id="nextBtn">Next</button>
              <button class="btn peach" id="generateBtn" style="display:none">Generate Packing List</button>
            </div>
          </div>
        </section>

        <!-- RIGHT: packing -->
        <aside class="packing-card" id="packingCard" aria-label="Packing area">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <h4 id="greeting">Hey Traveller!</h4>
              <div class="mini" id="tripSummary" style="color:var(--muted)">Trip summary appears here</div>
            </div>
            <div style="text-align:right;color:var(--muted);font-size:13px">
              <div id="routeSmall"></div>
            </div>
          </div>

          <div class="day-tabs" id="dayTabs" style="margin-top:10px;display:none"></div>

          <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
            <strong>Packing list</strong>
            <div style="font-size:13px;color:var(--muted)">Click to pack</div>
          </div>

          <div id="packingArea">
            <!-- before generating ‚Äî show sample/paged items -->
            <div class="items" id="itemsContainer" aria-live="polite"></div>

            <div style="display:flex;justify-content:center;gap:8px;margin-top:8px">
              <button id="prevItem" class="btn ghost">Prev</button>
              <div id="pageInfo" style="align-self:center;color:var(--muted)">Page 1/1</div>
              <button id="nextItem" class="btn ghost">Next</button>
            </div>
          </div>

          <!-- after generating: show the detailed list -->
          <div id="finalList" style="display:none" aria-live="polite">
            <div class="packing-list" id="generatedList"></div>
            <div style="margin-top:10px">
              <strong>Suitcase</strong>
              <div class="suitcase-drop" id="suitcaseDrop">
                <div class="suitcase-body"></div>
                <div class="suitcase-inner">
                  <div class="suitcase-slot" id="slotLeft" aria-live="polite"></div>
                  <div class="suitcase-slot" id="slotRight" aria-live="polite"></div>
                </div>
              </div>
              <div class="hint">Click an item to move it into the suitcase. Each item only once.</div>
            </div>
          </div>

        </aside>
      </div>
    </div>
  </div>

  <!-- JS logic -->
  <script>
    /* ======= CONFIG ======= */
    const API_KEY = '05f85e36fd42f0d1f359f276caab551f'; // keep for demo; for production move to server

    /* ======= STATE ======= */
    const state = {
      username: '',
      destination: '',
      from: '',
      to: '',
      duration: 3,
      gender: 'unspecified',
      company: '',
      mode: '',
      activities: [],
      medical: '',
      style: '',
      allItems: [],      // array of item names (when browsing pre-generate)
      generatedItems: [],// array of {name, qty}
      addedToSuitcase: new Set(),
      currentPage: 1,
      itemsPerPage: 8
    };

    /* ======= ELEMENTS ======= */
    const steps = Array.from(document.querySelectorAll('.form-step'));
    const progressBar = document.getElementById('progressBar');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const generateBtn = document.getElementById('generateBtn');
    const durationEl = document.getElementById('duration');
    const durationVal = document.getElementById('durationVal');
    const itemsContainer = document.getElementById('itemsContainer');
    const pageInfo = document.getElementById('pageInfo');
    const prevItem = document.getElementById('prevItem');
    const nextItem = document.getElementById('nextItem');
    const slotLeft = document.getElementById('slotLeft');
    const slotRight = document.getElementById('slotRight');
    const setDestBtn = document.getElementById('setDestBtn');
    const fromInput = document.getElementById('fromInput');
    const toInput = document.getElementById('toInput');
    const routeBtn = document.getElementById('routeBtn');
    const routeSuggestion = document.getElementById('routeSuggestion');
    const routeSmall = document.getElementById('routeSmall');
    const placeName = document.getElementById('placeName');
    const tempEl = document.getElementById('temp');
    const condEl = document.getElementById('cond');
    const greeting = document.getElementById('greeting');
    const tripSummary = document.getElementById('tripSummary');
    const formCard = document.getElementById('formCard');
    const packingCard = document.getElementById('packingCard');
    const itemsPerPage = state.itemsPerPage;

    /* ======= NAVIGATION (Next/Back) ======= */
    let currentStep = 0;
    function showStep(i){
      steps.forEach((s,idx)=> s.classList.toggle('active', idx===i));
      currentStep = i;
      const pct = Math.round(((i+1)/steps.length)*100);
      progressBar.style.width = pct + '%';
      prevBtn.style.display = i===0 ? 'none' : 'inline-block';
      nextBtn.style.display = i===steps.length-1 ? 'none' : 'inline-block';
      generateBtn.style.display = i===steps.length-1 ? 'inline-block' : 'none';
    }
    showStep(0);
    prevBtn.addEventListener('click', ()=> showStep(Math.max(0, currentStep-1)));
    nextBtn.addEventListener('click', ()=> showStep(Math.min(steps.length-1, currentStep+1)));

    /* ======= Option selection helpers ======= */
    function makeSingleSelect(id, onChange){
      const container = document.getElementById(id);
      container.addEventListener('click', e=>{
        const opt = e.target.closest('.option');
        if(!opt) return;
        container.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
        opt.classList.add('selected');
        if(onChange) onChange(opt.dataset.value);
      });
    }
    function makeLimitedMultiSelect(id, limit=4, stateArray){
      const container = document.getElementById(id);
      container.addEventListener('click', e=>{
        const opt = e.target.closest('.option');
        if(!opt) return;
        const val = opt.dataset.value;
        if(opt.classList.contains('selected')){
          opt.classList.remove('selected');
          const idx = stateArray.indexOf(val);
          if(idx>-1) stateArray.splice(idx,1);
        } else {
          if(stateArray.length >= limit){
            // little feedback animation
            opt.style.transform='scale(0.98)';
            setTimeout(()=>opt.style.transform='',120);
            return;
          }
          opt.classList.add('selected');
          stateArray.push(val);
        }
      });
    }

    /* bind single selects */
    makeSingleSelect('genderOptions', v=> state.gender = v);
    makeSingleSelect('companyOptions', v=> state.company = v);
    makeSingleSelect('modeOptions', v=> state.mode = v);
    makeSingleSelect('medicalOptions', v=> state.medical = v);
    makeSingleSelect('styleOptions', v=> state.style = v);
    makeLimitedMultiSelect('activityOptions', 4, state.activities);

    /* duration */
    durationEl.addEventListener('input', ()=>{
      state.duration = parseInt(durationEl.value,10);
      durationVal.innerText = durationEl.value;
    });

    /* ======= Weather & Set Destination ======= */
    setDestBtn.addEventListener('click', ()=>{
      const user = document.getElementById('username').value.trim();
      const dest = document.getElementById('destinationInput').value.trim();
      if(!user || !dest){ alert('Enter your name and destination'); return; }
      state.username = user;
      state.destination = dest;
      placeName.innerText = dest;
      greeting.innerText = `Hey ${state.username || 'Traveller'}!`;
      tripSummary.innerText = `${state.duration} day(s) ¬∑ ${state.company || '‚Äî'} ¬∑ ${state.mode || '‚Äî'}`;
      fetchWeather(dest);
    });

    async function fetchWeather(place){
      try{
        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(place)}&units=metric&appid=${API_KEY}`);
        const data = await res.json();
        if(data && data.main){
          tempEl.innerText = Math.round(data.main.temp) + '¬∞C';
          condEl.innerText = data.weather[0].main;
        } else {
          tempEl.innerText = 'N/A';
          condEl.innerText = '--';
        }
      }catch(err){
        console.log('weather error',err);
        tempEl.innerText = 'N/A';
        condEl.innerText = '--';
      }
    }

    /* ======= Route suggestion (list ALL plausible modes) ======= */
    routeBtn.addEventListener('click', ()=>{
      const from = fromInput.value.trim();
      const to = toInput.value.trim();
      state.from = from;
      state.to = to;
      if(!from || !to){ routeSuggestion.innerText = 'Enter both From and To to get route suggestions.'; routeSmall.innerText=''; return; }

      // Determine plausible transport modes. We always include Flight as possible,
      // and add others when plausible: train, bus, car, ship.
      const modes = new Set();
      modes.add('Flight');

      const isDomestic = isLikelyDomestic(from, to);
      if(isDomestic){
        modes.add('Train');
        modes.add('Bus');
        modes.add('Road (Car)');
      } else {
        // if either includes 'island' or 'sea' or 'port' or both coastal => include Ship
        if(mayHaveSeaRoute(from, to)) modes.add('Ship');
        // For medium distances, also include Train+Flight combos
        modes.add('Train + Flight (if partial)');
      }

      // Provide friendly list
      const list = Array.from(modes);
      routeSuggestion.innerHTML = `Possible: <strong>${list.join(' ¬∑ ')}</strong>`;
      routeSmall.innerText = `${from} ‚Üí ${to} ¬∑ ${list[0]}`;
    });

    function isLikelyDomestic(a,b){
      // naive heuristic: if both are short single-word tokens and do not include country names, assume domestic
      const foreign = ['japan','usa','united states','canada','uk','germany','france','australia','china','singapore','brazil','russia','italy'];
      const lowA = a.toLowerCase(), lowB = b.toLowerCase();
      for(const f of foreign) if(lowA.includes(f) || lowB.includes(f)) return false;
      // if both contain city-like names < 20 chars, probably domestic-ish
      if(a.length < 16 && b.length < 16) return true;
      return false;
    }
    function mayHaveSeaRoute(a,b){
      const coastalHints = ['sea','island','port','coast','harbor','bay','isle'];
      const combined = (a + ' ' + b).toLowerCase();
      for(const h of coastalHints) if(combined.includes(h)) return true;
      return false;
    }

    /* ======= Items generation rules (realistic quantities) ======= */
    function generatePackingList(){
      const days = state.duration;
      const gender = state.gender;
      const activities = state.activities.slice(); // copy
      const mode = state.mode;

      // base daily items
      const shirts = Math.max( Math.ceil(days * 1.0), 1 ); // 1 per day
      const underwear = Math.max( Math.ceil(days * 1.0), 1 );
      const socks = Math.max( Math.ceil(days * 1.0), 1 );
      // jeans & shorts heuristics
      const jeans = Math.max(1, Math.ceil(days / 4)); // one every 4 days
      const shorts = Math.max(0, Math.ceil(days / 3)); // one every 3 days
      const pajamas = Math.max(1, Math.ceil(days / 7));
      const jacket = (days > 5) ? 1 : (activities.includes('hiking') || activities.includes('ski') ? 1 : 0);
      const shoes = 1 + (activities.includes('hiking') ? 1 : 0); // one pair normal, add hiking shoes
      const sandals = activities.includes('beach') ? 1 : 0;
      const swimsuit = activities.includes('beach') ? 1 : 0;

      // electronics/essentials
      let chargers = 1;
      let camera = activities.includes('sightseeing') || activities.includes('adventure') ? 1 : 0;
      let powerbank = 1;
      let toiletries = 1;
      let meds = state.medical !== 'none' ? 1 : 0;

      // adjust for gender (non-stereotyping: allow modest adjustments for "different clothing needs")
      let extras = [];
      if(gender === 'female'){
        // slightly higher chance of extra outfits / layering
        extras.push({name:'Extra top/outfit', qty: Math.max(1, Math.ceil(days/5))});
      } else if(gender === 'male'){
        // no big change, maybe a couple more shirts for hot climates
        if(days > 7) extras.push({name:'Extra shirt', qty: Math.ceil(days/7)});
      }

      // activity-specific additions
      const activityMap = {
        beach: [{name:'Beach towel', qty:1},{name:'Flip-flops', qty:1}],
        hiking: [{name:'Backpack', qty:1},{name:'Trekking shoes', qty:1}],
        camping: [{name:'Sleeping bag', qty:1},{name:'Torch', qty:1}],
        sightseeing: [{name:'Guidebook', qty:1}],
        adventure: [{name:'Light protective gear', qty:1}],
        ski: [{name:'Ski jacket', qty:1},{name:'Thermals', qty:1}],
        city: [{name:'Day bag', qty:1}]
      };

      let list = [];

      // push core items
      list.push({name:'T-shirts', qty: shirts});
      if(jeans>0) list.push({name:'Jeans', qty: jeans});
      if(shorts>0) list.push({name:'Shorts', qty: shorts});
      list.push({name:'Underwear', qty: underwear});
      list.push({name:'Socks', qty: socks});
      if(pajamas>0) list.push({name:'Pajamas', qty: pajamas});
      if(jacket) list.push({name:'Jacket', qty: jacket});
      list.push({name:'Shoes (pairs)', qty: shoes});
      if(sandals) list.push({name:'Sandals', qty: sandals});
      if(swimsuit) list.push({name:'Swimsuit', qty: swimsuit});

      list.push({name:'Toiletries kit', qty: toiletries});
      if(meds) list.push({name:'Medical kit / prescriptions', qty:1});
      if(chargers) list.push({name:'Phone charger', qty: chargers});
      if(powerbank) list.push({name:'Powerbank', qty: powerbank});
      if(camera) list.push({name:'Camera', qty: camera});
      list.push({name:'Water bottle', qty:1});
      list.push({name:'Sunglasses', qty:1});
      list.push({name:'Hat / Cap', qty:1});
      list.push({name:'Notebook & pen', qty:1});

      // include activity extras
      for(const act of activities){
        const extrasForAct = activityMap[act] || [];
        extrasForAct.forEach(e => {
          // if item exists in list, increment qty
          const found = list.find(x=>x.name === e.name);
          if(found) found.qty = Math.max(found.qty, e.qty);
          else list.push({name:e.name, qty:e.qty});
        });
      }

      // style-based additions
      if(state.style === 'luxury'){
        list.push({name:'Evening outfit', qty: Math.max(1, Math.ceil(days/7))});
        list.push({name:'Evening shoes', qty:1});
      } else if(state.style === 'minimal'){
        // fewer items, use multi-use: reduce shirts a bit
        const shirtsItem = list.find(x=>x.name==='T-shirts');
        if(shirtsItem) shirtsItem.qty = Math.max( Math.ceil(shirtsItem.qty*0.8), 1 );
      }

      // quantity sanity: round and ensure integers
      list = list.map(x=>({name:x.name, qty: Math.max(1, Math.round(x.qty))}));

      // merge extras
      extras.forEach(e=>{
        const found = list.find(x=>x.name===e.name);
        if(found) found.qty += e.qty;
        else list.push({name:e.name, qty:e.qty});
      });

      // final unique and sorted
      const uniq = {};
      list.forEach(i=>{ if(uniq[i.name]) uniq[i.name] += i.qty; else uniq[i.name] = i.qty; });
      const final = Object.keys(uniq).map(k=>({name:k, qty:uniq[k]})).sort((a,b)=>a.name.localeCompare(b.name));

      state.generatedItems = final;
      return final;
    }

    /* ======= UI: pre-generate / sample items (before final) ======= */
    function buildSampleItems(){
      // small set to let user click & add before final generate if desired
      const sample = ['T-shirt','Pants','Jacket','Shoes','Socks','Toothbrush','Sunglasses','Charger','Water Bottle','Hat','Notebook','Camera'];
      state.allItems = sample;
      state.currentPage = 1;
      renderItemsPage();
    }

    function renderItemsPage(){
      const start = (state.currentPage - 1) * state.itemsPerPage;
      const end = start + state.itemsPerPage;
      const page = state.allItems.slice(start, end);
      itemsContainer.innerHTML = '';
      page.forEach(name=>{
        const div = document.createElement('div');
        div.className = 'item';
        div.innerText = name;
        if(state.addedToSuitcase.has(name)) { div.classList.add('added'); div.title='Already added'; }
        div.addEventListener('click', ()=> {
          if(state.addedToSuitcase.has(name)) return;
          addToSuitcase(name);
          div.classList.add('added');
        });
        itemsContainer.appendChild(div);
      });
      const total = Math.max(1, Math.ceil(state.allItems.length / state.itemsPerPage));
      pageInfo.innerText = `Page ${state.currentPage}/${total}`;
    }

    prevItem.addEventListener('click', ()=>{
      if(state.currentPage > 1){ state.currentPage--; renderItemsPage(); }
    });
    nextItem.addEventListener('click', ()=>{
      const total = Math.ceil(state.allItems.length / state.itemsPerPage);
      if(state.currentPage < total){ state.currentPage++; renderItemsPage(); }
    });

    function addToSuitcase(name){
      if(state.addedToSuitcase.has(name)) return;
      state.addedToSuitcase.add(name);
      const node = document.createElement('div');
      node.className = 'item';
      node.style.margin = '4px 0';
      node.innerText = name;
      if(slotLeft.childElementCount <= slotRight.childElementCount) slotLeft.appendChild(node);
      else slotRight.appendChild(node);
    }

    /* ======= Generate final packing list & change UI ======= */
    generateBtn.addEventListener('click', ()=>{
      // validate
      if(!state.username || !state.destination){
        alert('Please set your name and destination first.');
        return;
      }
      // build list
      const final = generatePackingList();

      // show final list UI, hide the left form (but keep navbar)
      document.getElementById('formCard').style.display = 'none';
      document.getElementById('packingArea').style.display = 'none';
      document.getElementById('finalList').style.display = 'block';

      // populate generatedList
      const generatedList = document.getElementById('generatedList');
      generatedList.innerHTML = '';
      final.forEach(item=>{
        const row = document.createElement('div');
        row.className = 'packing-row';
        const left = document.createElement('div');
        left.innerText = `${item.name}`;
        const right = document.createElement('div');
        right.innerText = `${item.qty}`;
        row.appendChild(left);
        row.appendChild(right);
        // make row clickable to add to suitcase
        row.style.cursor = 'pointer';
        row.addEventListener('click', ()=>{
          if(state.addedToSuitcase.has(item.name)) return;
          addToSuitcase(item.name);
          // visual cue: mark row as added
          row.style.opacity = '0.5';
        });
        generatedList.appendChild(row);
      });

      // hide next/back/generate controls completely
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      generateBtn.style.display = 'none';
    });

    /* ======= init ======= */
    (function init(){
      durationVal.innerText = durationEl.value;
      buildSampleItems();
    })();

    /* ======= small helpers & accessibility ======= */
    document.getElementById('destinationInput').addEventListener('keypress', e=> { if(e.key==='Enter') setDestBtn.click(); });
    fromInput.addEventListener('keypress', e=> { if(e.key==='Enter') routeBtn.click(); });
    toInput.addEventListener('keypress', e=> { if(e.key==='Enter') routeBtn.click(); });

    // keyboard activation for options
    document.querySelectorAll('.options').forEach(group=>{
      group.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && e.target.classList.contains('option')) e.target.click();
      });
    });

  </script>
</body>
</html>
{% endblock %}
