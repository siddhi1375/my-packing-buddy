{% extends 'main/base.html' %}

{% block title %}Destination{% endblock %}

{% block content %}
<style>
:root{
  --bg-a:#fdf6ff; --bg-b:#fffaf0; --card:#ffffff; --muted:#6b7280;
  --accent:#a0e4ff; --accent-2:#fbcfe8; --accent-3:#fce5cd; --selected:#7dd3fc;
}
*{box-sizing:border-box;} html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(135deg,var(--bg-a),var(--bg-b));color:#0f172a;} a{text-decoration:none;color:inherit;}

/* Header */
.main-header{width:100%;padding:16px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 10px rgba(0,0,0,0.08);} .logo{font-weight:600;font-size:20px;} .subtitle{font-size:12px;color:var(--muted);} .navbar a{margin-left:16px;font-weight:500;font-size:13px;color:#0f172a;} .navbar a:hover{color:var(--accent-2);} 

/* Main container */
.viewport{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;} .card-wrap{width:100%;max-width:1000px;background:linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.95));box-shadow:0 10px 30px rgba(2,6,23,0.08);border-radius:16px;padding:16px;}

/* Hero */
.hero{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(90deg, rgba(160,228,255,0.15), rgba(252,229,205,0.08));margin-top:8px;} .place-img{width:70px;height:50px;border-radius:8px;object-fit:cover;} .hero h1{margin:0;font-size:16px;} .hero p{margin:2px 0 0;color:var(--muted); font-size:12px;} .weather{text-align:right;font-size:12px;} 

/* Grid layout */
.main-grid{display:grid;grid-template-columns:1fr 380px;gap:12px;margin-top:12px;} @media(max-width:880px){.main-grid{grid-template-columns:1fr}} 

/* Form card */
.form-card{background:var(--card);padding:12px;border-radius:12px;} input, select{padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);width:100%;font-size:13px;} .btn{padding:8px 12px;border-radius:8px;font-size:13px;cursor:pointer;border:none;background:var(--accent);color:#05202b;} .btn:hover{opacity:0.9;} .btn.ghost{background:transparent;border:1px solid rgba(15,23,42,0.1);color:var(--muted);} .btn.coral{background:var(--accent-2);color:#401029;} .btn.peach{background:var(--accent-3);color:#4b2b05;} .options{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;} .option{padding:6px 10px;border-radius:999px;border:1px solid rgba(15,23,42,0.08);cursor:pointer;background:#fff;transition:all 0.2s ease;user-select:none;} .option.selected{background:var(--selected);color:#08202b;border-color:transparent;box-shadow:0 6px 16px rgba(125,211,252,0.12);} .form-step{display:none;} .form-step.active{display:block;} .progress{height:6px;background:rgba(2,6,23,0.04);border-radius:999px;overflow:hidden;margin-top:8px;} .progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%;}

/* Packing card */
.packing-card{background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.99));padding:12px;border-radius:12px;min-height:300px;} .day-tabs{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;} .day-tab{padding:4px 8px;border-radius:999px;border:1px solid rgba(15,23,42,0.1);cursor:pointer;} .day-tab.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#08202b;} .items{display:grid;gap:6px;margin-top:8px;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));}
.item{padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.98));display:flex;justify-content:space-between;align-items:center;cursor:grab;}
.suitcase-drop{min-height:220px;border-radius:12px;border:2px dashed rgba(15,23,42,0.1);padding:14px;background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.4));position:relative;overflow:hidden;}
.suitcase-drop::before{content:'';position:absolute;left:50%;top:8px;transform:translateX(-50%);width:160px;height:100px;background:linear-gradient(180deg,#f2f7fb,#e6f3ff);border-radius:10px;box-shadow:inset 0 -6px 20px rgba(0,0,0,0.03);} 
/* Designer suitcase visuals */
.suitcase-body{position:absolute;left:50%;top:30px;transform:translateX(-50%);width:320px;height:150px;background:linear-gradient(180deg,#e9f7ff,#ffffff);border-radius:10px;border:6px solid #dbeffd;box-shadow:0 8px 30px rgba(2,6,23,0.08);}
.suitcase-handle{position:absolute;left:50%;top:4px;transform:translateX(-50%);width:140px;height:18px;background:#dbeffd;border-radius:10px;border-bottom:3px solid rgba(0,0,0,0.05);} 
.suitcase-inner{position:absolute;left:50%;top:60px;transform:translateX(-50%);width:300px;height:100px;padding:10px;display:flex;gap:8px;align-items:flex-start;justify-content:flex-start;}
.suitcase-slot{flex:1;height:80px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);background:linear-gradient(180deg,#fff,#f8fbff);padding:6px;overflow:auto}
.hint{font-size:12px;color:var(--muted);margin-top:6px;} 

/* small screens adjustments */
@media(max-width:480px){.suitcase-body{width:240px;height:120px}.suitcase-inner{width:220px}}
</style>

<div class="viewport"> 
  <div class="card-wrap"> 
    <!-- Hero -->
    <div class="hero">
      <img src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1200&auto=format&fit=crop" class="place-img" alt="place">
      <div>
        <h1 id="placeName">Choose a destination</h1>
        <p id="placeTag">Pick a place and plan your packing list.</p>
      </div>
      <div class="weather">
        <div class="temp" id="temp">--°C</div>
        <div class="mini" id="cond">--</div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">

      <!-- Form Card -->
      <section class="form-card">
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <input id="username" placeholder="Your name (required)" style="flex:1;min-width:100px">
          <input id="destinationInput" placeholder="Destination (required)" style="flex:2;min-width:150px">
          <button class="btn" id="setDestBtn">Set</button>
        </div>

        <div class="progress" aria-hidden="true"><i id="progressBar"></i></div>

        <div id="formSteps" style="margin-top:8px">
          <!-- Step 1 -->
          <div class="form-step active" data-step="1">
            <h4>How many days?</h4>
            <input type="range" id="duration" min="1" max="30" value="3" oninput="durationVal.innerText=this.value">
            <div><strong><span id="durationVal">3</span> days</strong></div>

            <h4>Travel company (choose one)</h4>
            <div class="options" id="companyOptions">
              <div class="option" data-value="solo">Solo</div>
              <div class="option" data-value="partner">Partner</div>
              <div class="option" data-value="family">Family</div>
            </div>
          </div>

          <!-- Step 2 -->
          <div class="form-step" data-step="2">
            <h4>Travel mode (choose one)</h4>
            <div class="options" id="modeOptions">
              <div class="option" data-value="flight">Flight</div>
              <div class="option" data-value="train">Train</div>
              <div class="option" data-value="road">Road Trip</div>
            </div>

            <h4>Activities (choose multiple)</h4>
            <div class="options" id="activityOptions">
              <div class="option" data-value="beach">Beach</div>
              <div class="option" data-value="hiking">Hiking</div>
              <div class="option" data-value="camping">Camping</div>
              <div class="option" data-value="sightseeing">Sightseeing</div>
              <div class="option" data-value="adventure">Adventure</div>
            </div>
          </div>

          <!-- Step 3 -->
          <div class="form-step" data-step="3">
            <h4>Medical needs (choose up to 3, or "None")</h4>
            <div class="options" id="medicalOptions">
              <div class="option" data-value="none">None</div>
              <div class="option" data-value="allergy">Allergy</div>
              <div class="option" data-value="back">Back pain</div>
              <div class="option" data-value="pregnant">Pregnant</div>
              <div class="option" data-value="diabetes">Diabetes</div>
            </div>

            <h4>Work remotely? (choose one)</h4>
            <div class="options" id="workOptions">
              <div class="option" data-value="yes">Yes</div>
              <div class="option" data-value="no">No</div>
            </div>

            <div id="digitalNomadSection" style="display:none">
              <h4>Tech gear (choose multiple)</h4>
              <div class="options" id="techOptions">
                <div class="option" data-value="laptop">Laptop</div>
                <div class="option" data-value="powerbank">Powerbank</div>
                <div class="option" data-value="wifi">Wi-Fi</div>
              </div>
            </div>

          </div>

          <!-- Step 4 -->
          <div class="form-step" data-step="4">
            <h4>Profile</h4>
            <select id="gender">
              <option value="any">Prefer not to say</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
            <input id="age" type="number" placeholder="Age">

            <h4>Packing style (choose one)</h4>
            <div class="options" id="styleOptions">
              <div class="option" data-value="minimal">Minimalist</div>
              <div class="option" data-value="comfort">Comfort</div>
              <div class="option" data-value="luxury">Luxury</div>
            </div>
          </div>

          <!-- Step 5 -->
          <div class="form-step" data-step="5">
            <h4>All set!</h4>
            <p class="mini">Click <strong>Generate Packing List</strong> to create your packing list and virtual suitcase.</p>
          </div>
        </div>

        <div class="controls" style="display:flex;justify-content:space-between;margin-top:8px;">
          <button class="btn ghost" id="prevBtn">Back</button>
          <div>
            <button class="btn" id="nextBtn">Next</button>
            <button class="btn peach" id="generateBtn" style="display:none">Generate Packing List</button>
          </div>
        </div>
      </section>

      <!-- Packing Card -->
      <aside class="packing-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <h4 id="greeting">Hey Traveller!</h4>
            <div class="mini" id="tripSummary">Trip summary will appear here.</div>
          </div>
          <button class="btn coral" id="saveTrip">Save</button>
        </div>

        <div class="day-tabs" id="dayTabs"></div>
        <div class="items" id="itemsContainer" style="display:none;"></div>
        
         <div id="itemPagination" style="display:flex;justify-content:center;gap:8px;margin:8px 0;">
  <button id="prevItem" class="btn ghost">Prev</button>
  <button id="nextItem" class="btn ghost">Next</button>
</div>
        <div class="suitcase-drop" id="suitcaseDrop">
          <div class="suitcase-handle"></div>
          <div class="suitcase-body"></div>
          <div class="suitcase-inner">
            <div class="suitcase-slot" id="slotLeft"></div>
            <div class="suitcase-slot" id="slotRight"></div>
          </div>
        </div>

        <div class="hint">Drag items into suitcase. Tick items as you pack.</div>
      </aside>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// State
const state = {
  username: '',
  destination: '',
  duration: 3,
  company: '',
  mode: '',
  activities: [],
  medical: [],
  work: '',
  tech: [],
  gender: '',
  age: null,
  style: '',
  packingList: []
};

// Stepper
const steps = Array.from(document.querySelectorAll('.form-step'));
let currentStep = 0;
const progressBar = document.getElementById('progressBar');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const generateBtn = document.getElementById('generateBtn');

function showStep(i){
  steps.forEach((s,idx)=>s.classList.toggle('active', idx===i));
  currentStep = i;
  progressBar.style.width = Math.round(((i+1)/steps.length)*100)+'%';
  prevBtn.style.display = i===0 ? 'none' : 'inline-block';
  nextBtn.style.display = i===steps.length-1 ? 'none' : 'inline-block';
  generateBtn.style.display = i===steps.length-1 ? 'inline-block' : 'none';
}
showStep(0);
prevBtn.onclick = ()=> showStep(Math.max(0, currentStep-1));

// Utility to toggle selection
function makeSingleSelect(groupId){
  const group = document.getElementById(groupId);
  group.addEventListener('click', e=>{
    if(!e.target.classList.contains('option')) return;
    // single-select behavior
    group.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
    e.target.classList.add('selected');
  });
}

function makeMultiSelect(groupId){
  const group = document.getElementById(groupId);
  group.addEventListener('click', e=>{
    if(!e.target.classList.contains('option')) return;
    e.target.classList.toggle('selected');
  });
}

// Medical special logic
(function(){
  const group = document.getElementById('medicalOptions');
  group.addEventListener('click', e=>{
    if(!e.target.classList.contains('option')) return;
    const isNone = e.target.dataset.value === 'none';
    const selected = Array.from(group.querySelectorAll('.option.selected'));

    if(isNone){
      // select none and clear others
      group.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
      e.target.classList.add('selected');
    } else {
      // if none is selected, don't allow others
      const noneEl = group.querySelector('.option[data-value="none"]');
      if(noneEl.classList.contains('selected')){
        noneEl.classList.remove('selected');
      }
      const selectedNow = Array.from(group.querySelectorAll('.option.selected'));
      if(!e.target.classList.contains('selected')){
        // selecting
        if(selectedNow.length >= 3){
          alert('You can select maximum 3 medical options.');
          return;
        }
        e.target.classList.add('selected');
      } else {
        // unselecting
        e.target.classList.remove('selected');
      }
    }
  });
})();

// setup single/multi selects
makeSingleSelect('companyOptions');
makeSingleSelect('modeOptions');
makeMultiSelect('activityOptions');
makeSingleSelect('workOptions');
makeMultiSelect('techOptions');
makeSingleSelect('styleOptions');

// Digital nomad toggle show/hide tech options
document.getElementById('workOptions').addEventListener('click', e=>{
  if(!e.target.classList.contains('option')) return;
  const val = e.target.dataset.value;
  if(val === 'yes') document.getElementById('digitalNomadSection').style.display = 'block';
  else document.getElementById('digitalNomadSection').style.display = 'none';
});

// Set destination button (destination & username required to proceed)
document.getElementById('setDestBtn').onclick = ()=>{
  const name = document.getElementById('username').value.trim();
  const dest = document.getElementById('destinationInput').value.trim();
  if(!name || !dest){
    alert('Please enter your name and destination before proceeding.');
    return;
  }
  state.username = name;
  state.destination = dest;
  document.getElementById('placeName').innerText = dest;
  document.getElementById('greeting').innerText = `Hey ${name}!`;
  fetchWeather(dest);
};

// Duration
const durationEl = document.getElementById('duration');
durationEl.oninput = function(){ state.duration = parseInt(this.value); document.getElementById('durationVal').innerText = this.value; };

// Next button validation (disallow proceeding if required fields blank)
nextBtn.onclick = ()=>{
  // Step 0 validation: username & destination must be set (via Set button)
  if(currentStep === 0){
    if(!state.username || !state.destination){ alert('Please fill name and destination and click Set.'); return; }
  }

  if(currentStep === 1){
    // company required
    if(!document.querySelector('#companyOptions .option.selected')){ alert('Please select travel company.'); return; }
  }

  if(currentStep === 2){
    if(!document.querySelector('#modeOptions .option.selected')){ alert('Please select travel mode.'); return; }
    if(document.querySelectorAll('#activityOptions .option.selected').length === 0){ alert('Please choose at least one activity.'); return; }
  }

  if(currentStep === 3){
    if(!document.querySelector('#workOptions .option.selected')){ alert('Please choose whether you will work remotely.'); return; }
  }

  if(currentStep === 4){
    if(!document.querySelector('#styleOptions .option.selected')){ alert('Please choose packing style.'); return; }
  }

  showStep(Math.min(steps.length-1, currentStep+1));
};

// Weather fetch (keeps simple fallback)
function fetchWeather(place){
  // lightweight placeholder; keeps UI stable without relying on geocoding
  document.getElementById('temp').innerText = '--°C';
  document.getElementById('cond').innerText = 'Fetching...';
  // attempt open-meteo with static coord fallback
  fetch('https://api.open-meteo.com/v1/forecast?latitude=20&longitude=78&current_weather=true')
    .then(r=>r.json()).then(d=>{
      document.getElementById('temp').innerText = d.current_weather?.temperature + '°C' || '--°C';
      document.getElementById('cond').innerText = d.current_weather ? 'Clear' : '--';
    }).catch(()=>{ document.getElementById('temp').innerText='--°C'; document.getElementById('cond').innerText='--'; });
}

// Generate packing list
generateBtn.onclick = ()=>{
  // collect state from selections
  state.company = document.querySelector('#companyOptions .option.selected')?.dataset.value || '';
  state.mode = document.querySelector('#modeOptions .option.selected')?.dataset.value || '';
  state.activities = Array.from(document.querySelectorAll('#activityOptions .option.selected')).map(el=>el.dataset.value);
  state.medical = Array.from(document.querySelectorAll('#medicalOptions .option.selected')).map(el=>el.dataset.value);
  state.work = document.querySelector('#workOptions .option.selected')?.dataset.value || '';
  state.tech = Array.from(document.querySelectorAll('#techOptions .option.selected')).map(el=>el.dataset.value);
  state.style = document.querySelector('#styleOptions .option.selected')?.dataset.value || '';
  state.gender = document.getElementById('gender').value;
  state.age = document.getElementById('age').value;

  // final validation
  if(!state.company || !state.mode || state.activities.length===0 || !state.work || !state.style){
    alert('Please complete required selections before generating the packing list.');
    return;
  }

  // build packingList
  state.packingList = [];
  for(let d=1; d<=state.duration; d++){
    const dayItems = ['Shirts','Pants','Socks'];
    state.activities.forEach(a=> dayItems.push(cap(a)));
    if(state.work === 'yes') dayItems.push('Laptop','Charger');
    if(state.medical.length) dayItems.push(...state.medical.map(m=>cap(m)+' meds'));
    state.packingList.push({day:d, items: dayItems});
  }
  renderPacking();
};

function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

function renderPacking(){
  const dayTabs = document.getElementById('dayTabs');
  const itemsContainer = document.getElementById('itemsContainer');
  dayTabs.innerHTML=''; itemsContainer.innerHTML='';
  state.packingList.forEach(d=>{
    const tab = document.createElement('div'); tab.className='day-tab'; tab.innerText='Day '+d.day; tab.onclick=()=>showDay(d.day-1); dayTabs.appendChild(tab);
  });
  if(state.packingList.length) showDay(0);
}

function showDay(i){
  document.querySelectorAll('.day-tab').forEach((t,idx)=>t.classList.toggle('active', idx===i));
  const itemsContainer = document.getElementById('itemsContainer'); itemsContainer.style.display='grid'; itemsContainer.innerHTML='';
  state.packingList[i].items.forEach(it=>{
    const div = document.createElement('div'); div.className='item'; div.innerText = it; itemsContainer.appendChild(div);
  });
}

// Designer suitcase: already in markup with slots; use Sortable
new Sortable(document.getElementById('itemsContainer'),{group:'pack',animation:150});
new Sortable(document.getElementById('slotLeft'),{group:'pack',animation:150});
new Sortable(document.getElementById('slotRight'),{group:'pack',animation:150});

// simple save action (localStorage)
document.getElementById('saveTrip').onclick = ()=>{
  const payload = {state, savedAt: new Date().toISOString()};
  localStorage.setItem('savedTrip', JSON.stringify(payload));
  alert('Trip saved locally.');
};

// small UX: disable next if destination not set
setInterval(()=>{
  const disabled = !state.destination || !state.username;
  document.getElementById('nextBtn').disabled = disabled;
  document.getElementById('nextBtn').style.opacity = disabled?0.6:1;
},300);
</script>

{% endblock %}
